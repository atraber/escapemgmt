- hosts: server
  user: houdini
  become_user: root
  become_method: sudo
  tasks:
    - name: Install OS dependencies
      become: true
      apt:
        update_cache: yes
        cache_valid_time: 3600
        name: git,python3.4-venv
        state: present

    - name: Checkout github repository
      git: repo='https://github.com/atraber/escapemgmt.git' dest=/home/houdini/escapemgmt version=master

    - name: Create virtualenv
      pip:
        requirements: /home/houdini/escapemgmt/backend/requirements.txt
        virtualenv: /home/houdini/escapemgmt/backend/venv
        virtualenv_command: /usr/bin/python3 -m venv

    - name: Prepare frontend; Install npm dependencies
      command: npm install
      args:
        chdir: /home/houdini/escapemgmt/frontend

    - name: Prepare frontend; Build
      command: ./node_modules/@angular/cli/bin/ng build --environment=prod
      args:
        chdir: /home/houdini/escapemgmt/frontend

    - name: Update apache configuration
      become: true
      copy:
        dest: "/etc/apache2/sites-available/000-default.conf"
        content: |
          <VirtualHost *:80>
            # The ServerName directive sets the request scheme, hostname and port that
            # the server uses to identify itself. This is used when creating
            # redirection URLs. In the context of virtual hosts, the ServerName
            # specifies what hostname must appear in the request's Host: header to
            # match this virtual host. For the default virtual host (this file) this
            # value is not decisive as it is used as a last resort host regardless.
            # However, you must set it for any further virtual host explicitly.
            #ServerName www.example.com

            ServerAdmin webmaster@localhost
            DocumentRoot /home/houdini/escapemgmt/frontend/dist

            # Available loglevels: trace8, ..., trace1, debug, info, notice, warn,
            # error, crit, alert, emerg.
            # It is also possible to configure the loglevel for particular
            # modules, e.g.
            #LogLevel info ssl:warn

            ErrorLog ${APACHE_LOG_DIR}/error.log
            CustomLog ${APACHE_LOG_DIR}/access.log combined

            WSGIDaemonProcess escapemgmt python-path=/home/houdini/escapemgmt/backend:/home/houdini/escapemgmt/backend/venv/lib/python3.4/site-packages
            WSGIProcessGroup escapemgmt
            WSGIScriptAlias /raspi-api /home/houdini/escapemgmt/backend/app.wsgi
            <Directory /home/houdini/escapemgmt/backend>
              Require all granted
            </Directory>

            <FilesMatch "\.(jpg|jpeg|png|gif|ico)$">
              Header set Cache-Control "max-age=3600"
            </FilesMatch>

            Alias "/raspi" "/home/houdini/escapemgmt/frontend/dist"
            <Directory /home/houdini/escapemgmt/frontend/dist>
              Require all granted

              FallbackResource /raspi/index.html
            </Directory>
          </VirtualHost>

          # vim: syntax=apache ts=4 sw=4 sts=4 sr noet

    - name: Restart apache server
      become: true
      service:
        name: apache2
        state: restarted
